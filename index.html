<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Ausgaben</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@exampledev/new.css@1.1.3/new.min.css">
    <style>
        :invalid {
            border-color: #ec5840;
        }

        :invalid~button {
            /*buttons nach invaliden elementen unter gleichem parent sind disabled*/
            opacity: .5;
            pointer-events: none
        }

        .toggle label {
            float: left;
            font-size: 1.5rem;
            width: 9rem;
            margin-bottom: 0.5rem;
            background-color: var(--nc-bg-3);
        }

        .toggle label span {
            text-align: center;
            display: block;
            border-radius: 4px;
        }

        .toggle label input {
            position: absolute;
            top: -20px;
        }

        .payer input:checked+span {
            background-color: var(--nc-lk-1);
        }

        .menu input:checked+span {
            background-color: var(--nc-ac-1);
        }

        tr:hover {
            background-color: var(--nc-bg-3);
        }

        .fadeout {
            opacity: 0;
            transition: visibility 0s 2s, opacity 2s linear;
        }
    </style>
</head>

<body>
    <div class="toggle menu" style="display:flex">
        <label style="flex: 1 1 30%"><input type="radio" id="zahlungRadio" name="menuTabs" onclick="openTab('zahlungTab')" checked autocomplete="off"><span>Zahlung</span></label> <!-- autocomplete="off" damit FF sich checked state nicht merkt: https://stackoverflow.com/a/471140 -->
        <label style="flex: 1 1 30%"><input type="radio" id="historyRadio" name="menuTabs" onclick="openTab('historyTab')" autocomplete="off"><span>History</span></label>
    </div>
    <div id="zahlungTab" class="tabcontent">
        <div id="payerToggle" class="toggle payer" style="display:flex">
            <label><input type="radio" id="andreasRadio" name="payer" onclick="document.getElementById('amount').focus();updatePersonAmounts()" autocomplete="off" checked><span>Andreas</span></label>
            <label><input type="radio" id="dagmarRadio" name="payer" onclick="document.getElementById('amount').focus();updatePersonAmounts()" autocomplete="off"><span>Dagmar</span></label>
            <div style="font-size:1.3em;margin-left:0.8em" id="schulden"></div>
        </div>
        <form id="splitForm" autocomplete="off" onsubmit="return false;" style="display: grid;grid-template-columns: 12ch auto; align-items: baseline; column-gap: 0.5em">
            <label for="amount">Betrag</label>
            <input type="number" id="amount" name="amount" min="0" step="0.01" placeholder="Betrag" onfocus="this.select()" required>
            <label for="andreasShareAbs">Andreas</label>
            <input type="number" id="andreasShareAbs" name="andreasShareAbs" min="0" step="0.001" placeholder="Andreas Anteil" onfocus="this.select()">
            <label for="dagmarShareAbs">Dagmar</label>
            <input type="number" id="dagmarShareAbs" name="dagmarShareAbs" min="0" step="0.001" placeholder="Dagmar Anteil" onfocus="this.select()">
            <label for="kategorie">Kategorie</label>
            <select id="kategorie" name="kategorie" onchange="updatePersonAmounts()">
                <option value="Essen" selected>Essen</option>
                <option value="Trinken">Trinken</option>
                <option value="Amazon">Amazon</option>
                <option value="Kultur">Kultur</option>
                <option value="Unterkunft">Unterkunft</option>
                <option value="Verschiedenes">Verschiedenes</option>
                <option value="Geldtransfer">Geldtransfer</option>
            </select>
            <label for="dagmarShareAbs">Beschreibung</label>
            <input id="beschreibung" name="beschreibung" placeholder="Grund der Zahlung">
            <label for="zeitpunkt">Zeitpunkt</label>
            <input type="datetime-local" id="zeitpunkt" name="zeitpunkt" placeholder="Zeitpunkt der Zahlung">
            <button id="neu" onclick="neuClick()">Neu</button><button id="speichern" onclick="speichernClick()">Speichern <span id="editId"></span></button>
            <div></div>
            <div id="infoText"></div>
        </form>
    </div>
    <div id="historyTab" class="tabcontent" style="display: none">
        <div id="table-wrapper"></div>
        <button type="button" onclick="download()">Save</button>
    </div>
    <script>
        const andreasShareInput = document.getElementById('andreasShareAbs');
        andreasShareInput.addEventListener('input', () => updateOtherShare(andreasShareInput, dagmarShareInput));
        const dagmarShareInput = document.getElementById('dagmarShareAbs');
        dagmarShareInput.addEventListener('input', () => updateOtherShare(dagmarShareInput, andreasShareInput));
        const totalAmountInput = document.getElementById('amount');
        totalAmountInput.addEventListener('input', setDefaultSplit);
        const tabcontent = document.getElementsByClassName("tabcontent");
        const editIdDiv = document.getElementById('editId');
        document.getElementById("zeitpunkt").value = dateNow();
        updateSchulden();
        updatePersonAmounts();

        function download() {
            var anchor = document.createElement("a");
            anchor.download = "ausgaben_" + Date.now() + ".txt";
            const downloadContent = readLocalStorage().map(e => e[0] + "=" + e[1]).join("\n"); // relevanter localstorage content als key=value file
            anchor.href = window.URL.createObjectURL(new Blob([downloadContent], { type: "text/plain" }));
            anchor.target = "_blank";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);
        }
        function readLocalStorage() {
            return Object.entries(localStorage).sort().reverse().filter(e => e[0].startsWith("Ausgabe#"));
        }
        function openTab(tabName) {
            Array.from(document.getElementsByClassName("tabcontent")).forEach(t => t.style.display = "none");
            document.getElementById(tabName).style.display = "block";
            if (tabName === "historyTab") {
                let table = '<table><thead><tr><th>Zeitpunkt</th><th>Kategorie</th><th>Beschreibung</th><th>Zahler</th><th>Andreas</th><th>Dagmar</th><th>Gesamt</th></tr></thead><tbody>';
                readLocalStorage().forEach(entry => {
                    const json = JSON.parse(entry[1]); // der Zeitpkt ist der mittlere Teil des LocalStorage Keys (eingegrenzt durch _) zb Ausgabe#2025-10-31 10:44_1761903861769
                    const zeitpunkt = entry[0].split("#")[1];
                    const payer = json.s < 0 ? 'A' : 'D';
                    table += `<tr style="cursor: pointer" onClick="rowClick('${entry[0]}','${zeitpunkt}','${json.k}','${json.b}','${json.a}','${json.d}','${payer}')"><td>${zeitpunkt}</td><td>${json.k}</td><td>${json.b}</td><td>${payer + '('+ json.s +')'}</td><td>${json.a}</td><td>${json.d}</td><td>${add(json.a, json.d)}</td><td><button onClick="deleteClick('${entry[0]}', event)">X</button></td></tr>`
                });
                table += '</tbody></table>';
                document.getElementById('table-wrapper').innerHTML = table;
            }
        }
        function dateNow() { // Setup DateTime with Now https://stackoverflow.com/questions/24468518/html5-input-datetime-local-default-value-of-today-and-current-time/60884408#60884408
            var now = new Date();
            var nowUpToMin = new Date(now - now.getTimezoneOffset() * 60000);
            nowUpToMin.setSeconds(null);
            nowUpToMin.setMilliseconds(null);
            return nowUpToMin.toISOString().slice(0, -1); // schneide Z am Ende weg
        }
        function add(a, d) {
            return parseFloat(a) + parseFloat(d);
        }

        function rowClick(editId, zeitpunkt, k, b, a, d, p) {
            setEditId(editId);
            andreasShareInput.value = a;
            dagmarShareInput.value = d;
            document.getElementById('zeitpunkt').value = zeitpunkt;
            document.getElementById('amount').value = add(a, d);
            document.getElementById('beschreibung').value = b;
            document.getElementById('kategorie').value = k;
            document.getElementById('zahlungRadio').checked = true;
            document.getElementById(p == 'A' ? 'andreasRadio' : 'dagmarRadio').checked = true;
            openTab('zahlungTab');
        }
        function deleteClick(rowLocalStorageKey, event) {
            if (window.confirm("Wirklich löschen?")) {
                const thisTr = event.target.parentElement.parentElement;
                thisTr.parentElement.removeChild(thisTr);
                localStorage.removeItem(rowLocalStorageKey);
            }
            event.stopPropagation(); // das line click event soll nicht triggern
            updateSchulden();
        }
        // Automatically set default split to 50/50 when amount changes
        function setDefaultSplit() {
            const amount = parseFloat(totalAmountInput.value);
            const half = amount / 2;
            andreasShareInput.value = half.toFixed(3);
            dagmarShareInput.value = half.toFixed(3);
            updatePersonAmounts();
        }

        function updateOtherShare(thisInput, otherInput) {
            otherInput.value = (totalAmountInput.value - thisInput.value).toFixed(2);
            updatePersonAmounts();
        }
        function neuClick() {
            rowClick(null, dateNow(), '', '', '', '', '');
        }
        function speichernClick() { // die Keys enthalten den Zeitpkt damit die Sortierung danach passiert
            const editId = editIdDiv.textContent !== "" ? editIdDiv.textContent : "Ausgabe#" + document.getElementById('zeitpunkt').value.replace("T", " ") + "#" + Date.now();
            const aFloat = parseFloat(andreasShareInput.value);
            const dFloat = parseFloat(dagmarShareInput.value);
            localStorage.setItem(editId, JSON.stringify({ // nachdem die Zeit nur min-genau ist steht am Ende ein epochMs Suffix
                a: aFloat,
                d: dFloat,
                b: document.getElementById('beschreibung').value,
                k: document.getElementById('kategorie').value,
                s: document.getElementById('andreasRadio').checked ? -dFloat : +aFloat, // wenn A wird der D Betrag mit - eingetragen (- sind Schulden von D bei A). wenn D wird der A Betrag mit + eingetragen (+ sind Schulden von A bei D)
            }));
            setEditId(editId);
            document.getElementById('infoText').textContent = "Ausgabe wurde gespeichert und kann bis auf den Zeitpunkt editiert werden";
            document.getElementById('infoText').className = "";
            document.getElementById('infoText').offsetHeight; // trigger reflow https://stackoverflow.com/a/45036752
            document.getElementById('infoText').className = "fadeout";
            updateSchulden();
        }
        function updateSchulden() {
            const sum= readLocalStorage().map(entry => {
                const json = JSON.parse(entry[1]);
                return json.s;
            }).reduce((a, b) => a + b, 0);
            document.getElementById('schulden').textContent = sum > 0 ? "Andreas schuldet Dagmar " + sum + "€": "Dagmar schuldet Andreas " + (-sum) + "€";
        }
        function setEditId(editId) {
            editIdDiv.textContent = editId;
            document.getElementById('zeitpunkt').readOnly = editId !== null;
        }
        function updatePersonAmounts() {
            const geldtransfer = document.getElementById('kategorie').value == "Geldtransfer";
            const amount = parseFloat(totalAmountInput.value);
            let andreasAmount = parseFloat(andreasShareInput.value);
            let dagmarAmount = parseFloat(dagmarShareInput.value);

            if (geldtransfer || isNaN(amount) || amount <= 0) { // Geldtransfer erlaubt keinen custom split sondern ist immer 100% bei der Gegenseite
                andreasShareInput.disabled = true;
                dagmarShareInput.disabled = true;
                if (geldtransfer) {
                    const amount = parseFloat(totalAmountInput.value);
                    andreasShareInput.value = document.querySelector('input[name = payer]:checked').id == "andreasRadio" ? "0" : amount;
                    dagmarShareInput.value = andreasShareInput.value == "0" ? amount : "0";
                }
                return;
            }
            andreasShareInput.disabled = false;
            dagmarShareInput.disabled = false;
        }
    </script>
</body>

</html>